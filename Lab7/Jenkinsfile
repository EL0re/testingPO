pipeline 
{
    agent any 
    stages 
    {
        stage('Qemu') 
        {
            steps 
            {
                echo 'Stage Qemu: Cleaning and preparing environment'
                sh 'rm -rf romulus romulus.zip'
                
                echo 'Stage Qemu: Updating packages and installing dependencies'
                sh 'apt update && apt install -y qemu-system wget unzip'
                
                echo 'Stage Qemu: Downloading romulus.zip'
                sh 'wget https://jenkins.openbmc.org/job/ci-openbmc/lastSuccessfulBuild/distro=ubuntu,label=docker-builder,target=romulus/artifact/openbmc/build/tmp/deploy/images/romulus/*zip*/romulus.zip'
                sh 'unzip romulus.zip'
                
                echo 'Stage Qemu: Starting QEMU emulator'
                sh ''' 
                    LATEST_MTD=$(ls romulus/obmc-phosphor-image-romulus-*.static.mtd | sort -V | tail -1)
                    echo "Using MTD file: $LATEST_MTD"
                    
                    qemu-system-arm \
                        -m 256 \
                        -M romulus-bmc \
                        -nographic \
                        -drive file=$LATEST_MTD,format=raw,if=mtd \
                        -net nic \
                        -net user,hostfwd=:0.0.0.0:2222-:22,hostfwd=:0.0.0.0:2443-:443,hostfwd=udp:0.0.0.0:2623-:623 \
                        > qemu_output.log 2>&1 &
                        
                    QEMU_PID=$!
                    echo "QEMU started with PID: $QEMU_PID"
                    echo $QEMU_PID > qemu.pid
                    
                    echo "Waiting for QEMU to boot..."
                    sleep 180
                    
                    if ps -p $QEMU_PID > /dev/null; then
                        echo "QEMU is running successfully"
                    else
                        echo "ERROR: QEMU process died"
                        echo "QEMU output:"
                        cat qemu_output.log
                        exit 1
                    fi
                '''
            }
        }
        stage('Debug Tests') {
            steps {
                echo 'Debugging why tests fail...'
                dir('../Lab4') {
                    sh '''
                        echo "=== Testing Chrome Driver ==="
                        chromedriver --version
                        
                        echo "=== Simple Selenium Test ==="
                        python3 -c "
                        from selenium import webdriver
                        from selenium.webdriver.chrome.options import Options
                        from selenium.webdriver.common.by import By
                        import time

                        options = Options()
                        options.add_argument('--ignore-certificate-errors')
                        options.add_argument('--headless')
                        options.add_argument('--no-sandbox')
                        options.add_argument('--disable-dev-shm-usage')
                        options.add_argument('--disable-gpu')
                        options.binary_location = '/usr/bin/chromium'

                        print('Testing Chrome driver...')
                        try:
                            driver = webdriver.Chrome(options=options)
                            print('✅ Chrome driver started successfully')
                            
                            print('Navigating to login page...')
                            driver.get('https://127.0.0.1:2443/login')
                            print(f'Page title: {driver.title}')
                            print(f'Current URL: {driver.current_url}')
                            
                            # Делаем скриншот для диагностики
                            driver.save_screenshot('debug_login_page.png')
                            print('Screenshot saved as debug_login_page.png')
                            
                            # Ищем элементы логина
                            print('Looking for login form elements...')
                            inputs = driver.find_elements(By.TAG_NAME, 'input')
                            print(f'Found {len(inputs)} input elements')
                            
                            for i, inp in enumerate(inputs):
                                input_id = inp.get_attribute('id')
                                input_type = inp.get_attribute('type')
                                input_name = inp.get_attribute('name')
                                print(f'Input {i}: id={input_id}, type={input_type}, name={input_name}')
                            
                            # Проверяем есть ли нужные элементы
                            username_found = any(inp.get_attribute('id') == 'username' for inp in inputs)
                            password_found = any(inp.get_attribute('id') == 'password' for inp in inputs)
                            
                            print(f'Username field found: {username_found}')
                            print(f'Password field found: {password_found}')
                            
                            if username_found and password_found:
                                print('✅ Login form elements found')
                                
                                # Пробуем заполнить форму
                                username_field = driver.find_element(By.ID, 'username')
                                password_field = driver.find_element(By.ID, 'password')
                                
                                username_field.send_keys('root')
                                password_field.send_keys('0penBmc')
                                print('✅ Form filled successfully')
                                
                                # Пробуем отправить форму
                                password_field.submit()
                                time.sleep(3)
                                print(f'After submit - URL: {driver.current_url}')
                                print(f'After submit - Title: {driver.title}')
                                
                            else:
                                print('❌ Login form elements not found')
                                print('Page source (first 1000 chars):')
                                print(driver.page_source[:1000])
                            
                            driver.quit()
                            print('✅ Selenium test completed')
                            
                        except Exception as e:
                            print(f'❌ Selenium error: {e}')
                            import traceback
                            traceback.print_exc()
                        "
                    '''
                }
                
                dir('../Lab6') {
                    sh '''
                        echo "=== Simple Locust Test ==="
                        python3 -c "
                        import requests
                        import urllib3
                        urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

                        try:
                            print('Testing Redfish API endpoints...')
                            
                            # Test 1: Basic Systems endpoint
                            response = requests.get('https://127.0.0.1:2443/redfish/v1/Systems/system', 
                                                verify=False, timeout=10, auth=('root', '0penBmc'))
                            print(f'Systems/system endpoint - Status: {response.status_code}')
                            
                            if response.status_code == 200:
                                data = response.json()
                                print(f'System ID: {data.get(\\\"Id\\\", \\\"Not found\\\")}')
                                print(f'PowerState: {data.get(\\\"PowerState\\\", \\\"Not found\\\")}')
                                print('✅ Redfish Systems endpoint works')
                            else:
                                print(f'❌ Redfish Systems endpoint failed: {response.status_code}')
                                print(f'Response: {response.text[:200]}')
                            
                            # Test 2: Root Systems endpoint  
                            response = requests.get('https://127.0.0.1:2443/redfish/v1/Systems', 
                                                verify=False, timeout=10, auth=('root', '0penBmc'))
                            print(f'Systems endpoint - Status: {response.status_code}')
                            
                            # Test 3: Without authentication
                            response = requests.get('https://127.0.0.1:2443/redfish/v1/Systems/system', 
                                                verify=False, timeout=10)
                            print(f'Systems without auth - Status: {response.status_code}')
                                
                        except Exception as e:
                            print(f'❌ Error: {e}')
                            import traceback
                            traceback.print_exc()
                        "
                    '''
                }
            }
        }
        stage('Auto') 
        {
            steps 
            {
                echo 'Stage Auto: Installing python3 and test dependencies'
                sh 'apt install -y python3 python3-pytest python3-selenium'
                
                echo 'Stage Auto: Running Selenium autotests'
                catchError(buildResult: 'SUCCESS', stageResult: 'UNSTABLE') 
                {
                    dir('../Lab4') {
                        sh 'ls'
                        sh 'python3 -m pytest -v autotests.py > autotest_results.txt 2>&1'
                        archiveArtifacts 'autotest_results.txt'
                    }
                }
            }
        }
        stage('Locust') 
        {
            steps 
            {
                echo 'Stage Locust: Installing Locust load testing tool'
                sh 'apt install -y python3 locust'
                
                catchError(buildResult: 'SUCCESS', stageResult: 'UNSTABLE') 
                {
                    echo 'Stage Locust: Running load tests'
                    dir('../Lab6') {
                        sh 'ls'
                        sh 'timeout 180 locust --headless --users 50 --spawn-rate 5 --run-time 3m --host=https://127.0.0.1:2443 > locust_results.txt 2>&1'
                        archiveArtifacts 'locust_results.txt'
                    }
                }
            }
        }
        stage('Stop Qemu') 
        {
            steps 
            {
                echo 'Stage Stop Qemu: Stopping QEMU emulator and cleaning up'
                sh '''
                    if [ -f "qemu.pid" ]; then
                        QEMU_PID=$(cat qemu.pid)
                        kill $QEMU_PID 2>/dev/null || true
                        rm -f qemu.pid
                        echo "QEMU stopped"
                    fi
                    rm -rf romulus/ romulus.zip || true
                    rm -f *.log *.pid *.json *.csv || true
                    rm -f qemu.pid image_path.txt config.env || true
                    du -sh . | awk '{print $1}'
                '''
            }
        }
    }
    post 
    {
        always 
        {
            echo 'Archiving all test-related text files...'
            archiveArtifacts artifacts: '**/*.txt', fingerprint: true
            echo 'Pipeline finished.'
        }
    }
}
