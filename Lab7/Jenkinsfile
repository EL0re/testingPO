pipeline 
{
    agent any 
    stages 
    {
        stage('Qemu') 
        {
            steps 
            {
                echo 'Stage Qemu: Cleaning and preparing environment'
                sh 'rm -rf romulus romulus.zip'
                
                echo 'Stage Qemu: Updating packages and installing dependencies'
                sh 'apt update && apt install -y qemu-system wget unzip'
                
                echo 'Stage Qemu: Downloading romulus.zip'
                sh 'wget https://jenkins.openbmc.org/job/ci-openbmc/lastSuccessfulBuild/distro=ubuntu,label=docker-builder,target=romulus/artifact/openbmc/build/tmp/deploy/images/romulus/*zip*/romulus.zip'
                sh 'unzip romulus.zip'
                
                echo 'Stage Qemu: Starting QEMU emulator'
                sh ''' 
                    LATEST_MTD=$(ls romulus/obmc-phosphor-image-romulus-*.static.mtd | sort -V | tail -1)
                    echo "Using MTD file: $LATEST_MTD"
                    
                    qemu-system-arm \
                        -m 256 \
                        -M romulus-bmc \
                        -nographic \
                        -drive file=$LATEST_MTD,format=raw,if=mtd \
                        -net nic \
                        -net user,hostfwd=:0.0.0.0:2222-:22,hostfwd=:0.0.0.0:2443-:443,hostfwd=udp:0.0.0.0:2623-:623 \
                        > qemu_output.log 2>&1 &
                        
                    QEMU_PID=$!
                    echo "QEMU started with PID: $QEMU_PID"
                    echo $QEMU_PID > qemu.pid
                    
                    echo "Waiting for QEMU to boot..."
                    sleep 180
                    
                    if ps -p $QEMU_PID > /dev/null; then
                        echo "QEMU is running successfully"
                    else
                        echo "ERROR: QEMU process died"
                        echo "QEMU output:"
                        cat qemu_output.log
                        exit 1
                    fi
                '''
            }
        }
        stage('Debug File Structure') {
            steps {
                sh '''
                    echo "=== Complete Workspace Structure ==="
                    pwd
                    echo "--- Root workspace ---"
                    ls -la
                    echo "--- Searching for test files recursively ---"
                    find . -name "*.py" -type f | head -20
                    echo "--- Lab directories ---"
                    ls -la Lab*/ || echo "No Lab directories"
                    echo "--- All directories ---"
                    ls -la */ || echo "No subdirectories"
                '''
            }
        }

        stage('Find Test Files') {
            steps {
                sh '''
                    echo "=== Searching for test files ==="
                    find . -name "autotest.py" -o -name "locustfile.py" | head -10
                '''
            }
        }

        stage('Auto') {
            steps {
                sh '''
                    # Запускаем из той директории где найден файл
                    python3 -m pytest -v $(find . -name "autotest.py" -type f | head -1) > autotest_results.txt 2>&1
                '''
                archiveArtifacts 'autotest_results.txt'
            }
        }

        stage('Locust') {
            steps {
                sh '''
                    LOCUST_FILE=$(find . -name "locustfile.py" -type f | head -1)
                    if [ -n "$LOCUST_FILE" ]; then
                        cd $(dirname "$LOCUST_FILE")
                        timeout 60 locust --headless --users 1 --spawn-rate 1 --run-time 30s --host=https://127.0.0.1:2443 > locust_results.txt 2>&1
                    else
                        echo "locustfile.py not found" > locust_results.txt
                    fi
                '''
                archiveArtifacts 'locust_results.txt'
            }
        }
        stage('Stop Qemu') 
        {
            steps 
            {
                echo 'Stage Stop Qemu: Stopping QEMU emulator and cleaning up'
                sh '''
                    if [ -f "qemu.pid" ]; then
                        QEMU_PID=$(cat qemu.pid)
                        kill $QEMU_PID 2>/dev/null || true
                        rm -f qemu.pid
                        echo "QEMU stopped"
                    fi
                    rm -rf romulus/ romulus.zip || true
                    rm -f *.log *.pid *.json *.csv || true
                    rm -f qemu.pid image_path.txt config.env || true
                    du -sh . | awk '{print $1}'
                '''
            }
        }
    }
    post 
    {
        always 
        {
            echo 'Archiving all test-related text files...'
            archiveArtifacts artifacts: '**/*.txt', fingerprint: true
            echo 'Pipeline finished.'
        }
    }
}
